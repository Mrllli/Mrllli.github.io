---
layout: post
title: 内存管理
tags: 栈 堆
---

> 一个程序在可执行文件中的结果，可以分为两个部分：只读部分和可读写部分。只读部分包括程序代码`(.text)`和程序中的常量`(.rodata)`，可读写部分可分为下面几个部分：`.data`、`.bss`、`heap`、`stack`（在内存中的存在形式）

> - `.data`： 初始化了的全局变量和静态变量
> - `.bss`： 即 Block Started by Symbol， 未初始化的全局变量和静态变量
> - `heap`： 堆，使用 malloc, realloc, 和 free 函数控制的变量，堆在所有的线程，共享库，和动态加载的模块中被共享使用
> - `stack`： 栈，函数调用时使用栈来保存函数现场，自动变量（即生命周期限制在某个 scope 的变量）也存放在栈中。

> **data和bss**
>
> ```
> int val = 3;
> ```
>
> 这个变量**值**一开始被储存在.text中，在程序启动时被拷贝到.data区中
>
> ```
> static int i;
> ```
>
> 这个变量会被放在bss区

> **栈**
>
> 栈是用于存放本地变量，内部临时变量以及有关上下文的内存区域。程序在调用函数时，系统会自动压栈和弹栈，不需手动干预
>
> 栈是一块连续的内存区域。能从栈获得的空间较小。如果申请的空间超过栈的剩余空间时，例如递归过深，将提示`stackoverflow`。
>
> 分配专门寄存器存放栈的地址，计算机底层支持，因此栈的效率比较高

> **堆**
>
> 堆是用于存放除了栈里的东西之外的所有其它东西的内存区域。由手工控制，容易产生内存泄露
>
> 堆是向高地址扩展的数据结构，不连续的内存区域，这是由于系统通过链表储存空闲内存地址，由低地址到高地址遍历。堆空间比较灵活也比较大。
>
> 容易造成大量碎片，使程序效率降低
>
> 堆是动态分配的，手工实现，堆由C/C++函数库提供，效率比栈要低

> **全局变量**
>
> 可以在当下文件中使用，也可以在其它文件中使用

> **静态变量**
>
> 在函数外定义：全局变量，只可在当前文件中可见
>
> 在函数内定义：全局变量，但只在函数内可见

