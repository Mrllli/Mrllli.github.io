---
layout: post
title: 通信机制详解
tags: 通信
---

> 众所周知，网络模型最开始分为七层，应用层，会话层，表示层，传输层，网络层，链路层和物理层。现在已经将七层网络模型简化成5层，分别是应用层，传输层，网络层，链路层和物理层。今天就来完整的说一下，两台机器之间是如何基于5层网络协议进行通信。
>
> 首先是应用层，应用的协议为http，在浏览器输入一个网址后，就是发送一个http请求，请求里包含http所需要的请求头，请求体等格式。这时开始建立TCP三次握手，就是在传输层进行，TCP三次握手中第一次握手需要客户端发送一个数据包给服务器，这时第一次发送的数据包就要通过网络层来发送。网络层是IP协议，通过将IP与路由表上的子网掩码进行与操作，看看是否是同一个网络号，如果是同一个网络号，则再经过链路层和物理层发送。如果不是一个网络号，则在数据包上加上mac地址，进行下一跳操作，mac地址就是下一个节点或者说是网关的mac地址，然后下一个网关拿到数据包后对比里面的ip和自己的ip地址，如果不是，则撕毁原mac地址，加上自己的mac地址，这个mac地址指向下一个节点的地址，继续进行跳跃操作，重复这些过程。因此数据包中的ip地址不变，mac地址一直在变，如同链路一样，因此叫链路层。最后就可以发送到服务器的主机上，然后服务器对其进行解析。实际上如同一个channel，一个管道，管道包含的是socket和TCP协议，然后数据不断从管道中冒出交给HTTP进行解析。解析完的数据分发给TomCat容器里的servlet进行相应的代码处理即可。
>
> 另外补充一点TCP是长连接，早先的HTTP1.0会主动切断连接，因此看起来似乎是短连接。但是HTTP1.1以后加入KeepAlive，也成为长连接，不会断开。且是先建立握手，再发送HTTP请求