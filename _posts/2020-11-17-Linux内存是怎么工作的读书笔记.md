---
layout: post
title: Linux内存是怎么工作的读书笔记
---

> ​    	普通进程能看到的其实是虚拟内存，32位操作系统的虚拟地址空间为4GB，其中1GB的空间分配给内核，另外3GB为用户空间，64位操作系统，虚拟地址内核空间为128T，用户空间为128T，所有进程的虚拟地址空间相互独立，通过内存映射来管理，内核会为每个进程都维护一张页表，其中只有真正被使用到的虚拟内存才会被分配物理内存，具体映射是通过CPU的内存管理单元(MMU)中的页表来映射，一个页表项所映射的内存为4KB，由于一个进程虚拟内存有4GB，因此需要4GB/4KB个页表项，算下来有上百万个。因此linux采用多级页表来管理内存，多级页表就是将映射关系改为区块索引和区块内偏移，由于虚拟内存空间通常只用了很少一部分，因此，多级页表只保存这些使用中的区块，大大减少页表的项数。当进程访问的虚拟地址在页表中查不到时，系统会产生一个缺页异常，进入内核态分配物理内存，更新进程页表，再返回用户态，恢复进程的运行。

> **虚拟内存分段**
> 地址从高到低分别是：
>
> 内核空间
>
> 栈：一般是8MB
>
> 文件映射：从高向低增长
>
> 堆：从低向高增长
>
> 数据段：全局变量等
>
> 只读段：常量，代码
>
> C标准库提供的malloc函数有两种实现方式，对于小块内存分配使用brk()，使用brk()分配内存是通过移动堆顶来实现，使用完后不会立即归还，可重复使用。另外一种是mmap()来分配内存，每次mmap都会导致大量缺页异常，因此只对大块内存使用，其实当使用这两种调用后并不会真正分配内存，而是等到首次访问时才分配，因此首次访问的时候才会发生缺页异常，如果只分配不释放会发生内存泄漏，因此使用free()或者unmap()来释放内存。当物理内存紧张的时候，系统内核会通过一系列机制回收内存：
>
> 回收算法LRU，回收最近使用最少的内存页面
>
> 回收不常访问的内存，将不常用的内存通过交换分区直接写到磁盘中
>
> 杀死进程，通过OOM，杀掉占用大量内存的进程

> **交换分区**简称Swap，其实就是把磁盘的一块空间当内存来使用，可以把进程暂时不用的内存写入磁盘，等到要用的时候再拿出来，由于磁盘读写速度过慢，因此Swap可能会导致眼胀的性能问题

> **OOM**是通过给每一个进程打分(oom_score)，如果一个进程占用的内存越大，分数就越高，就越容易被OOM杀死。

> **Linux查看内存使用相关工具：**
>
> **free：**
>
> ```bash
> ubuntu@VM-0-16-ubuntu:~$ free
>               total        used        free      shared  buff/cache   available
> Mem:        1877504     1533720       73200       19144      270584      177920
> Swap:             0           0           0
> ```
>
> total：总共内存的大小
>
> used：已经使用的内存大小
>
> free：空余内存大小
>
> shared：共享内存大小
>
> buff：缓冲区内存大小
>
> available：新进程可用内存大小（包括空余内存大小和可回收缓冲内存大小）
>
> **top:**
>
> ```bash
> ubuntu@VM-0-16-ubuntu:~$ top
>   PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
>  7443 redis     20   0  710172 264892      0 S 24.5 14.1   1607:59 kdevtmpfsi//病毒
> 13603 redis     20   0  730716 265352    700 S 24.5 14.1   1375:57 redis2
>  7393 root      20   0   12492   2352   1868 R  6.0  0.1  22789:20 reset_db_root_p
>     7 root      20   0       0      0      0 S  1.0  0.0   3103:58 ksoftirqd/0
> 12136 root      20   0  517304  15236   2860 S  0.3  0.8 103:09.82 barad_agent
> ```
>
> VIRT：虚拟内存大小
>
> RES：占用实际物理内存的大小
>
> SHR：共享内存大小
>
> %MEM：进程使用物理内存占系统总内存百分比