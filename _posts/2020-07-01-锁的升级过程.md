---
layout: post
title: 锁的升级过程
---

> 一个对象锁的信息是放在markword里的，因此就是8个字节，64位信息
>
> 一个对象加锁的状态有好几种，分别是无锁态，偏向锁，轻量级锁和重量级锁，这其中就有一个升级的过程了
>
> 一开始，一个对象是无锁的状态，然后一个线程来了，给这个对象加了一个偏向锁，这个偏向锁就是把线程的ID放到了对象的markword里，这是在竞争不激烈的情况下使用的锁，如果这时候又来一个线程，它也要使用这个对象，跟原来这个线程竞争，那么这个新线程现在做的第一件事就是把偏向锁从对象markword里撕下来，在自己的线程栈里创建一个LockRecord对象，并把对象的指针放到markword里，这个放的过程就是CAS操作，简单来说就是，从对象的markword里读取现在指针对的值，然后存起来，把它换成自己指针的值，然后再尝试写入对象的markword里，如果写的时候读取到的值和刚开始存的值不一样，那就再来循环一次，如果一样的话，就可以把新改的指针的值成功写入对象的markword里，现在该线程就占有了该对象，其它竞争的线程继续在门外进行刚开始的CAS操作，因此这也叫自旋锁，如果门外的线程太多，就会造成CPU资源的极大浪费，这时候就会升级成重量级锁，重量级锁是向内核申请的锁，使用该锁以后，门外其它线程全部进入相当于wait状态，不消耗CPU资源，相当于被冷冻住...
>
> synchronized默认是轻量级锁，大概过4秒后如果竞争不激烈会变成偏向锁，然后就是锁的升级过程...

